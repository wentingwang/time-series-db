test_setup:
  name: "Multi-Index Data Migration Test"
  description: "Tests query execution across data migrated between indices with resolved partitions"

  index_configs:
    - name: "metrics_index1"
      shards: 2
      replicas: 0
    - name: "metrics_index2"
      shards: 2
      replicas: 0

test_case:
  name: "Data Migration with Moving Sum Query"

  input_data_list:
    - index_name: "metrics_index1"
      input_data_type: FIXED_INTERVAL
      time_config:
        min_timestamp: "2025-01-01T00:00:00Z"
        max_timestamp: "2025-01-01T01:05:00Z"
        step: "5m"
      regular_metrics:
        - labels: "name:requests,service:service1"
          values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]
        - labels: "name:requests,service:service2"
          values: [1, 2, 3, 4, 5, 6, null, null, null, null, null, null, null]

    - index_name: "metrics_index2"
      input_data_type: FIXED_INTERVAL
      time_config:
        min_timestamp: "2025-01-01T00:30:00Z"
        max_timestamp: "2025-01-01T01:00:00Z"
        step: "5m"
      regular_metrics:
        - labels: "name:requests,service:service2"
          values: [7, 8, 9, 10, 11, 12, 13]

  queries:
    - name: "metric_no_migration_moving_sum"
      type: "m3ql"
      query: "fetch name:requests service:service1 | moving 10m sum"
      indices: "metrics_index1"
      time_config:
        min_timestamp: "2025-01-01T00:00:00Z"
        max_timestamp: "2025-01-01T01:05:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {name: "requests", service: "service1"}
            values: [null, 1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23]
    - name: "metric_with_migration_moving_sum__pushdown"
      type: "m3ql"
      query: "fetch name:requests service:service2 | moving 10m sum"
      indices: "metrics_index1,metrics_index2"
      resolved_partitions:
        - fetch: "fetch name:requests"
          windows:
            - partition: "metrics_index1"
              start: "2025-01-01T00:00:00Z"
              end: "2025-01-01T00:30:00Z"
              partition_keys: "service:service2"
            - partition: "metrics_index2"
              start: "2025-01-01T00:30:00Z"
              end: "2025-01-01T01:00:00Z"
              partition_keys: "service:service2"
      time_config:
        min_timestamp: "2025-01-01T00:00:00Z"
        max_timestamp: "2025-01-01T01:05:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: { name: "requests", service: "service2" }
            values: [ null, 1, 3, 5, 7, 9, 11, 7, 15, 17, 19, 21, 23 ]
            # 7, 15 instead of 13, 15 because of pushdown, an incorrect result, in case of pushdown with migration
    - name: "metric_with_migration_moving_sum__no_pushdown"
      type: "m3ql"
      query: "fetch name:requests service:service2 | moving 10m sum"
      indices: "metrics_index1,metrics_index2"
      resolved_partitions:
        - fetch: "fetch name:requests"
          windows:
            - partition: "metrics_index1"
              start: "2025-01-01T00:00:00Z"
              end: "2025-01-01T00:32:00Z"
              partition_keys: "service:service2"
            - partition: "metrics_index2"
              start: "2025-01-01T00:30:00Z"
              end: "2025-01-01T01:00:00Z"
              partition_keys: "service:service2"
      time_config:
        min_timestamp: "2025-01-01T00:00:00Z"
        max_timestamp: "2025-01-01T01:05:00Z"
        step: "5m"
      expected:
        status: "success"
        data:
          - metric: {name: "requests", service: "service2"}
            values: [null, 1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23]
