# Multi-Shard Multi-Node TSDB Integration Test
# Demonstrates distributed data ingestion and querying across multiple shards and nodes

test_setup:
  name: "Multi-Shard Multi-Node TSDB Test"
  description: "Tests TSDB with 3 shards distributed across 3 nodes with replica support"

  # Cluster configuration - Framework will start 3 data nodes
  cluster_config:
    nodes: 3  # 3 data nodes

  # Index configuration with multiple shards
  index_configs:
    - name: "multi_shard_metrics"
      shards: 3      # 3 primary shards - data will be distributed across them
      replicas: 1

test_case:
  name: "Multi-Shard Distribution Test"

  # Input data with multiple different label sets
  # Each unique label set will hash to a shard based on the seriesId
  input_data_list:
    - index_name: "multi_shard_metrics"
      input_data_type: FIXED_INTERVAL
      time_config:
        min_timestamp: "now-50m"
        max_timestamp: "now-10m"
        step: "10m"

      regular_metrics:
      # Series 1: API requests for service A
      - labels: "name:api_requests_total,service:service_a,endpoint:/users,status:200"
        values: [100, 120, 110, 95, 105]

      # Series 2: API requests for service A with 404
      - labels: "name:api_requests_total,service:service_a,endpoint:/users,status:404"
        values: [5, 8, 6, 4, 7]

      # Series 3: API requests for service B
      - labels: "name:api_requests_total,service:service_b,endpoint:/products,status:200"
        values: [200, 210, 205, 215, 220]

      # Series 4: API requests for service B with 500
      - labels: "name:api_requests_total,service:service_b,endpoint:/products,status:500"
        values: [2, 1, 3, 2, 1]

      # Series 5: API requests for service C
      - labels: "name:api_requests_total,service:service_c,endpoint:/orders,status:200"
        values: [150, 160, 155, 165, 170]

      # Series 6: API requests for service C with 404
      - labels: "name:api_requests_total,service:service_c,endpoint:/orders,status:404"
        values: [8, 10, 9, 11, 12]

      # Series 7: Database queries for service A
      - labels: "name:db_queries_total,service:service_a,operation:select,status:success"
        values: [500, 520, 510, 490, 505]

      # Series 8: Database queries for service B
      - labels: "name:db_queries_total,service:service_b,operation:select,status:success"
        values: [800, 820, 810, 830, 840]

      # Series 9: Cache hits for service A
      - labels: "name:cache_hits_total,service:service_a,cache_type:redis"
        values: [1000, 1050, 1020, 980, 1010]

      # Series 10: Cache hits for service B
      - labels: "name:cache_hits_total,service:service_b,cache_type:redis"
        values: [1500, 1550, 1520, 1580, 1600]

  # Queries that aggregate data across multiple shards
  queries:
    # Query 1: Aggregate API requests by service
    - name: "api_requests_by_service"
      type: "m3ql"
      indices: "multi_shard_metrics"
      query: "fetch name:api_requests_total | sumSeries service"
      time_config:
        min_timestamp: "now-50m"
        max_timestamp: "now"
        step: "10m"
      expected:
        status: "success"
        data:
          - metric: {service: "service_a"}
            values: [105, 128, 116, 99, 112]  # sum of service_a series
          - metric: {service: "service_b"}
            values: [202, 211, 208, 217, 221]  # sum of service_b series
          - metric: {service: "service_c"}
            values: [158, 170, 164, 176, 182]  # sum of service_c series

    # Query 2: Aggregate all database queries
    - name: "total_db_queries"
      type: "m3ql"
      indices: "multi_shard_metrics"
      query: "fetch name:db_queries_total | sumSeries"
      time_config:
        min_timestamp: "now-50m"
        max_timestamp: "now"
        step: "10m"
      expected:
        status: "success"
        data:
          - metric: {}
            values: [1300, 1340, 1320, 1320, 1345]  # sum of all db_queries

    # Query 3: Aggregate by status code across all services
    - name: "api_requests_by_status"
      type: "m3ql"
      indices: "multi_shard_metrics"
      query: "fetch name:api_requests_total | sumSeries status"
      time_config:
        min_timestamp: "now-50m"
        max_timestamp: "now"
        step: "10m"
      expected:
        status: "success"
        data:
          - metric: {status: "200"}
            values: [450, 490, 470, 475, 495]  # sum of all 200 status
          - metric: {status: "404"}
            values: [13, 18, 15, 15, 19]       # sum of all 404 status
          - metric: {status: "500"}
            values: [2, 1, 3, 2, 1]            # sum of all 500 status

    # Query 4: Specific service endpoint
    - name: "service_b_products_endpoint"
      type: "m3ql"
      indices: "multi_shard_metrics"
      query: "fetch name:api_requests_total service:service_b endpoint:/products | transformNull 6"
      time_config:
        min_timestamp: "now-80m"
        max_timestamp: "now"
        step: "10m"
      expected:
        status: "success"
        data:
          - metric: {name: "api_requests_total", service: "service_b", endpoint: "/products", status: "200"}
            values: [6, 6, 6, 200, 210, 205, 215, 220]
          - metric: {name: "api_requests_total", service: "service_b", endpoint: "/products", status: "500"}
            values: [6, 6, 6, 2, 1, 3, 2, 1]
